<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 ç¾©å¤§åˆ©åŒ—ç¾©ç¶“å…¸èˆ‡å˜‰å¹´è¯ 13æ—¥å®¶åº­æ¼«éŠæ‰‹å†Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        
        /* Themes */
        .theme-venice { background-color: #e0f2fe; border-left: 5px solid #0ea5e9; }
        .theme-florence { background-color: #ffedd5; border-left: 5px solid #f97316; }
        .theme-bologna { background-color: #fee2e2; border-left: 5px solid #ef4444; }
        .theme-milan { background-color: #f3e8ff; border-left: 5px solid #a855f7; }
        
        /* Tags */
        .tag {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }
        .tag-food { background-color: #dcfce7; color: #166534; }
        .tag-spot { background-color: #dbeafe; color: #1e40af; }
        .tag-dark { background-color: #374151; color: #f3f4f6; }
        .tag-transport { background-color: #fef9c3; color: #854d0e; }
        
        .time-col {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #4b5563;
            min-width: 50px;
            display: inline-block;
        }

        /* Edit Mode Styles */
        .editable-input {
            width: 100%;
            border: 1px dashed #cbd5e1;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255,255,255,0.5);
            transition: all 0.2s;
        }
        .editable-input:focus {
            background: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .edit-controls {
            display: none;
        }
        body.editing .edit-controls {
            display: flex;
        }
        body.editing .view-only {
            display: none;
        }
        /* Map Button Styles */
        .map-btn {
            opacity: 0.6;
            transition: opacity 0.2s;
            color: #ef4444; /* red-500 */
            margin-left: 0.5rem;
        }
        .map-btn:hover {
            opacity: 1;
        }
        .transport-map-btn {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            background-color: #eff6ff;
            color: #2563eb;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
            margin-left: 8px;
            text-decoration: none;
            transition: all 0.2s;
        }
        .transport-map-btn:hover {
            background-color: #dbeafe;
            transform: translateY(-1px);
        }

        /* Tab Navigation Styles */
        .nav-tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }
        .nav-tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 700;
        }
        .nav-tab:hover:not(.active) {
            color: #374151;
            background-color: #f9fafb;
        }
        
        /* Chat Widget Styles */
        #chat-widget {
            transition: all 0.3s ease-in-out;
            z-index: 1000;
        }
        .chat-message {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @media print {
            .no-print { display: none !important; }
            body { 
                background-color: white !important; 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }
            .page-break { page-break-before: always; }
            .shadow-xl { box-shadow: none !important; }
            .theme-venice, .theme-florence, .theme-bologna, .theme-milan {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .hero-bg {
                background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://images.unsplash.com/photo-1520175480921-4edfa2983e0f?q=80&w=2067&auto=format&fit=crop') !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            /* Hide edit interface when printing */
            .edit-controls { display: none !important; }
            .editable-input { 
                border: none !important; 
                background: transparent !important;
                padding: 0 !important;
            }
            /* Hide map buttons in print */
            .map-btn, .transport-map-btn { display: none !important; }
            
            /* Print Layout Tweaks */
            .nav-tabs-container { display: none !important; } /* Hide tabs in print, just show content */
            #view-itinerary, #view-luggage { display: block !important; } /* Force show all content when printing */
            .tab-header-print { display: block !important; margin-top: 2rem; border-bottom: 2px solid #ccc; padding-bottom: 0.5rem; margin-bottom: 1rem;}
        }
        
        .hero-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://images.unsplash.com/photo-1520175480921-4edfa2983e0f?q=80&w=2067&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        
        .tab-header-print { display: none; }
    </style>
</head>
<body class="antialiased relative">

    <!-- Floating Buttons -->
    <div class="fixed bottom-8 right-8 z-50 no-print flex flex-col gap-3 items-end">
        <button id="edit-toggle-btn" onclick="toggleEditMode()" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center gap-2 transform hover:scale-105">
            <i class="fas fa-edit"></i> <span id="edit-btn-text">ç·¨è¼¯å…§å®¹</span>
        </button>
        <button onclick="toggleChat()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center gap-2 transform hover:scale-105">
            <i class="fas fa-sparkles text-yellow-300"></i> Gemini éš¨èº«å°éŠ
        </button>
        <button id="print-btn" onclick="handlePrint()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center gap-2">
            <i class="fas fa-print"></i> åˆ—å° / å­˜æˆ PDF
        </button>
    </div>

    <!-- Gemini Chat Widget -->
    <div id="chat-widget" class="fixed bottom-24 right-8 w-96 h-[500px] bg-white rounded-2xl shadow-2xl flex flex-col hidden no-print border border-gray-200 overflow-hidden transform origin-bottom-right transition-all duration-300 scale-95 opacity-0">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-2">
                <i class="fas fa-robot text-2xl"></i>
                <div>
                    <h3 class="font-bold">Gemini ç¾©å¤§åˆ©å°éŠ</h3>
                    <p class="text-xs text-purple-200">å·²åŒæ­¥æ‚¨ç›®å‰çš„è‡ªè¨‚è¡Œç¨‹</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="hover:bg-white/20 rounded-full p-2 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <div class="chat-message flex gap-3">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-sparkles text-purple-600 text-xs"></i>
                </div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 max-w-[85%] border border-gray-100">
                    <p>Ciao! æˆ‘æ˜¯æ‚¨çš„ Gemini éš¨èº«å°éŠ âœ¨</p>
                    <p class="mt-2">æˆ‘æœƒæ ¹æ“šæ‚¨ç·¨è¼¯çš„è¡Œç¨‹ä¾†å›ç­”å•é¡Œã€‚æ‚¨å¯ä»¥éš¨æ™‚é»æ“Šå³å´çš„ <i class="fas fa-edit"></i> æŒ‰éˆ•ä¾†ä¿®æ”¹è¡Œç¨‹ã€‚</p>
                </div>
            </div>
        </div>
        <div class="p-4 bg-white border-t border-gray-200">
            <div class="flex gap-2 relative">
                <input type="text" id="user-input" placeholder="è¼¸å…¥å•é¡Œ..." class="flex-1 bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:bg-white transition outline-none" onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" class="bg-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-purple-700 transition shadow-md">
                    <i class="fas fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl min-h-screen flex flex-col" id="print-area">
        
        <!-- Cover Page -->
        <div class="hero-bg h-[500px] flex flex-col justify-center items-center text-white text-center p-8 relative flex-shrink-0">
            <div class="absolute top-0 left-0 w-full h-full bg-black opacity-20"></div>
            <div class="relative z-10">
                <h3 class="text-xl md:text-2xl font-light tracking-widest mb-2 uppercase">Italy Travel Guide</h3>
                <h1 class="text-4xl md:text-6xl font-bold mb-4 leading-tight">2026 ç¾©å¤§åˆ©<br>ç¶“å…¸èˆ‡å˜‰å¹´è¯ä¹‹æ—…</h1>
                <div class="w-24 h-1 bg-white mx-auto mb-6"></div>
                <div class="bg-white/20 backdrop-blur-sm p-6 rounded-lg border border-white/30 inline-block text-left">
                    <p class="mb-2"><i class="fas fa-calendar-alt mr-2"></i> <strong>æ—¥æœŸï¼š</strong> 2026/02/12 - 02/24 (13å¤©)</p>
                    <p class="mb-2"><i class="fas fa-users mr-2"></i> <strong>æˆå“¡ï¼š</strong> å“¥å“¥ã€å¼Ÿå¼Ÿ</p>
                    <p><i class="fas fa-map-marker-alt mr-2"></i> <strong>åŸå¸‚ï¼š</strong> ç±³è˜­ â” å¨å°¼æ–¯ â” ä½›ç¾…å€«æ–¯ â” æ³¢éš†é‚£ â” ç±³è˜­</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation (Screen Only) -->
        <div class="bg-white border-b border-gray-200 nav-tabs-container no-print sticky top-0 z-40 shadow-sm">
            <div class="flex justify-center">
                <div class="nav-tab active" onclick="switchTab('itinerary')" id="tab-itinerary">
                    <i class="fas fa-map-marked-alt mr-2"></i> è¡Œç¨‹èˆ‡äº¤é€š
                </div>
                <div class="nav-tab" onclick="switchTab('luggage')" id="tab-luggage">
                    <i class="fas fa-suitcase-rolling mr-2"></i> è¡Œææª¢æŸ¥æ¸…å–®
                </div>
            </div>
        </div>

        <!-- View: Itinerary -->
        <div id="view-itinerary" class="flex-1">
            <!-- Section 2: Transport -->
            <div class="p-8 md:p-12 border-b border-gray-200 bg-gray-50">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-red-600 pl-3">ğŸš„ äº¤é€šæ”»ç•¥è¡¨</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="py-3 px-4 text-left">æ—¥æœŸ</th>
                                <th class="py-3 px-4 text-left">è·¯ç·š</th>
                                <th class="py-3 px-4 text-left">å»ºè­°ç­æ¬¡</th>
                                <th class="py-3 px-4 text-left">äº¤é€šå·¥å…·</th>
                            </tr>
                        </thead>
                        <tbody class="text-sm" id="transport-body">
                            <!-- Transport rows generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section 3: Itinerary -->
            <div class="p-8 md:p-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-8 text-center uppercase tracking-widest">Daily Itinerary â€¢ æ¯æ—¥è¡Œç¨‹</h2>
                <div id="itinerary-container">
                    <!-- Itinerary content will be injected here by JavaScript -->
                </div>
                
                <div class="text-center mt-8 edit-controls">
                    <button onclick="addNewCityBlock()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded border border-gray-300 flex items-center mx-auto gap-2">
                        <i class="fas fa-plus-circle"></i> æ–°å¢åŸå¸‚å€å¡Š
                    </button>
                </div>
            </div>
        </div>

        <!-- View: Luggage Checklist -->
        <div id="view-luggage" class="flex-1 hidden">
            <div class="p-8 md:p-12 bg-white min-h-[500px]">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-l-4 border-green-600 pl-3 tab-header-print">ğŸ§³ è¡Œææª¢æŸ¥æ¸…å–® (å†¬å­£ç¾©å¤§åˆ©ç‰ˆ)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="luggage-container">
                    <!-- Luggage items injected by JS -->
                </div>
                <div class="mt-8 text-center edit-controls">
                    <button onclick="addLuggageCategory()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-2 px-4 rounded border border-blue-300 inline-flex items-center gap-2">
                        <i class="fas fa-folder-plus"></i> æ–°å¢åˆ†é¡
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 4: Footer -->
        <div class="bg-gray-800 text-gray-300 p-8 text-center text-sm page-break mt-auto">
            <p class="mb-2"><i class="fas fa-exclamation-triangle text-yellow-500"></i> <strong>é‡è¦æé†’ï¼š</strong> æ‰’æ‰‹çŒ–ç—ï¼Œè«‹éš¨æ™‚æ³¨æ„è²¡ç‰©å®‰å…¨ã€‚</p>
            <p>Â© 2026 Italy Family Trip Guidebook</p>
        </div>
    </div>

    <!-- DATA & LOGIC -->
    <script>
        // --- 1. Initial Data Structure ---
        const defaultData = {
            // Note: 'checklists' object removed/deprecated in favor of the new 'luggage' structure for the tab
            luggage: [
                {
                    category: "å¿…å‚™è­‰ä»¶èˆ‡è²¡ç‰©",
                    items: ["è­·ç…§ (æœ‰æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)", "æ©Ÿç¥¨/ç«è»Šç¥¨è¡Œç¨‹å–® (ç´™æœ¬+é›»å­)", "ç¾é‡‘ (æ­å…ƒ) & ä¿¡ç”¨å¡ (éœ€é–‹é€šæµ·å¤–ææ¬¾)", "ç”³æ ¹ä¿éšªè­‰æ˜ (è‹±æ–‡ç‰ˆ)", "é˜²ç›œè…°åŒ…/æ›ç¹©"]
                },
                {
                    category: "å†¬å­£è¡£ç‰© (2æœˆç¾©å¤§åˆ©: 0-10Â°C)",
                    items: ["é˜²é¢¨ä¿æš–å¤§è¡£/ç¾½çµ¨è¡£", "ç™¼ç†±è¡£/è¤² (3-4å¥—)", "èˆ’é©é˜²æ°´å¥èµ°é‹ (å¨å°¼æ–¯å¯èƒ½æœ‰æ°´æ‚£)", "åœå·¾ã€æ¯›å¸½ã€æ‰‹å¥—", "ç¾Šæ¯›è¥ª (å¤šé›™)", "è¼•ä¾¿å®¤å…§æ‹–é‹ (æ­æ´²é£¯åº—é€šå¸¸ä¸æä¾›)"]
                },
                {
                    category: "é›»å­ç”¢å“",
                    items: ["è¬ç”¨è½‰æ¥é ­ (ç¾©å¤§åˆ© Type L/C)", "è¡Œå‹•é›»æº (éš¨èº«æ”œå¸¶)", "æ‰‹æ©Ÿå……é›»ç·š/å™¨", "ç¶²å¡/Wi-Fiæ©Ÿ", "ç›¸æ©Ÿ/è¨˜æ†¶å¡"]
                },
                {
                    category: "ç›¥æ´—èˆ‡é†«è—¥",
                    items: ["ç‰™åˆ·ç‰™è† (æ­æ´²é£¯åº—ä¸æä¾›)", "ä¿æ¿•ä¹³æ¶²/è­·å”‡è† (æ°£å€™ä¹¾ç‡¥)", "å€‹äººå¸¸å‚™è—¥å“ (æ„Ÿå†’/è…¸èƒƒ/æ­¢ç—›)", "OKç¹ƒ/è…³è²¼ (é˜²ç£¨è…³)", "å£ç½©/ä¹¾æ´—æ‰‹"]
                },
                {
                    category: "å…¶ä»–å¯¦ç”¨å°ç‰©",
                    items: ["æ‘ºç–Šé›¨å‚˜/é›¨è¡£ (å†¬å­£å¤šé›¨)", "è³¼ç‰©è¢‹ (è¶…å¸‚ä¸æä¾›å¡‘è† è¢‹)", "æš–æš–åŒ…", "å¤¾éˆè¢‹ (æ”¶ç´å°ç‰©/ç¥¨æ ¹)", "ä¿æº«ç“¶"]
                }
            ],
            transport: [
                { date: "2/12", route: "æ©Ÿå ´ (MXP) â” ç±³è˜­ä¸­å¤®è»Šç«™", time: "08:13 / 08:43", type: "Malpensa Express" },
                { date: "2/12", route: "ç±³è˜­ä¸­å¤®è»Šç«™ â” å¨å°¼æ–¯", time: "10:35 / 11:35", type: "Frecciarossa / Italo", highlight: true },
                { date: "2/15", route: "å¨å°¼æ–¯ â” ä½›ç¾…å€«æ–¯", time: "11:00 å·¦å³", type: "Frecciarossa / Italo" },
                { date: "2/19", route: "ä½›ç¾…å€«æ–¯ â” æ³¢éš†é‚£", time: "11:00 å·¦å³", type: "Frecciarossa / Italo" },
                { date: "2/21", route: "æ³¢éš†é‚£ â” ç±³è˜­ä¸­å¤®è»Šç«™", time: "10:30 å·¦å³", type: "Frecciarossa / Italo" },
                { date: "2/23", route: "ç±³è˜­ â†” Crema (ä¾†å›)", time: "æ¯å°æ™‚ä¸€ç­", type: "Regionale (å€é–“è»Š)" },
                { date: "2/24", route: "ç±³è˜­å¸‚å€ â” æ©Ÿå ´ (MXP)", time: "07:25 / 07:55", type: "Malpensa Express" }
            ],
            itinerary: [
                {
                    city: "VENEZIA â€¢ å¨å°¼æ–¯",
                    subtitle: "å˜‰å¹´è¯çš„è¯éº—åºå¹• (Day 1-3)",
                    image: "https://images.unsplash.com/photo-1514890547357-a9ee288728e0?q=80&w=2070&auto=format&fit=crop",
                    theme: "theme-venice",
                    colorClass: "text-blue-600",
                    borderClass: "border-blue-500",
                    days: [
                        {
                            title: "Day 1 | 2/12 (å››) æŠµé”èˆ‡å˜‰å¹´è¯",
                            icon: "fa-plane-arrival",
                            stay: "ä½å®¿ï¼šå¨å°¼æ–¯",
                            activities: [
                                { time: "06:50", content: "æŠµé”ç±³è˜­ MXP æ©Ÿå ´ (T1)ã€‚" },
                                { time: "08:13", content: "æ­ä¹˜ Malpensa Express å‰å¾€ç±³è˜­ä¸­å¤®è»Šç«™ã€‚" },
                                { time: "10:35", content: "æ­ä¹˜é«˜éµ (Frecciarossa/Italo) å‰å¾€å¨å°¼æ–¯ã€‚" },
                                { time: "13:05", content: "æŠµé”å¨å°¼æ–¯ S. Lucia è»Šç«™ã€‚è³¼è²·æ°´ä¸Šå·´å£« 72hr é€šç¥¨ã€‚" },
                                { time: "14:30", content: "è¾¦ç†ä½å®¿ Check-inï¼Œç¨ä½œä¼‘æ¯ã€‚" },
                                { time: "16:00", content: "Rialto æ©‹æ•£æ­¥ï¼Œæ„Ÿå—å˜‰å¹´è¯åºå¹•ã€‚" },
                                { time: "18:00", content: "æ™šé¤ï¼šé«”é©— Cicchetti å°é£Ÿ + ç™½é…’ã€‚" }
                            ]
                        },
                        {
                            title: "Day 2 | 2/13 (äº”) å¨å°¼æ–¯çš„å¿ƒè‡Ÿ",
                            icon: "fa-mask",
                            stay: "",
                            activities: [
                                { time: "09:30", content: "è–é¦¬å¯å»£å ´æ¬£è³ Coser è£æ‰®ã€‚" },
                                { time: "10:30", content: "åƒè§€è–é¦¬å¯å¤§æ•™å ‚ (å«é»ƒé‡‘ç¥­å£‡)ã€‚" },
                                { time: "12:00", content: "äº«ç”¨åˆé¤ã€‚" },
                                { time: "14:00", content: "åƒè§€ç¸½ç£å®®èˆ‡å˜†æ¯æ©‹ (å¤ç›£ç„)ã€‚" },
                                { time: "16:30", content: "æ­ä¹˜ Gondola (è²¢å¤šæ‹‰) é³³å°¾èˆ¹éŠæ²³ã€‚" },
                                { time: "18:00", content: "è‡ªç”±æ´»å‹• / äº«ç”¨æ™šé¤ã€‚" }
                            ]
                        },
                        {
                            title: "Day 3 | 2/14 (å…­) å½©è‰²å³¶ & æƒ…äººç¯€",
                            icon: "fa-palette",
                            stay: "",
                            activities: [
                                { time: "09:00", content: "æ­èˆ¹å‰å¾€å¤–å³¶ (12è™Ÿç·š)ã€‚" },
                                { time: "10:00", content: "æŠµé” Murano (ç»ç’ƒå³¶) åƒè§€ã€‚" },
                                { time: "11:30", content: "æŠµé” Burano (å½©è‰²å³¶) æ‹ç…§ã€‚" },
                                { time: "13:00", content: "åˆé¤ï¼šBurano å¿…åƒå¢¨é­šéºµã€‚" },
                                { time: "15:30", content: "æ­èˆ¹è¿”å›å¨å°¼æ–¯æœ¬å³¶ã€‚" },
                                { time: "16:30", content: "æ¢è¨ªæ²‰èˆ¹æ›¸åº—ã€‚" },
                                { time: "19:00", content: "æ™šé¤ï¼šå˜‰å¹´è¯æƒ…äººç¯€å¤§é¤ (å‹™å¿…é è¨‚)ã€‚" }
                            ]
                        }
                    ]
                },
                {
                    city: "FIRENZE â€¢ ä½›ç¾…å€«æ–¯",
                    subtitle: "æ–‡è—å¾©èˆˆèˆ‡æ‰˜æ–¯å¡å°¼è‰·é™½ (Day 4-7)",
                    image: "https://images.unsplash.com/photo-1534239695462-6585749d3469?q=80&w=2070&auto=format&fit=crop",
                    theme: "theme-florence",
                    colorClass: "text-orange-600",
                    borderClass: "border-orange-500",
                    days: [
                        {
                            title: "Day 4 | 2/15 (æ—¥) æ–‡è—å¾©èˆˆèµ·é»",
                            icon: "fa-train",
                            stay: "ä½å®¿ï¼šä½›ç¾…å€«æ–¯",
                            activities: [
                                { time: "09:00", content: "æ—©èµ·é€› Rialto é­šå¸‚å ´ã€‚" },
                                { time: "11:00", content: "æ­ä¹˜é«˜éµå‰å¾€ä½›ç¾…å€«æ–¯ã€‚" },
                                { time: "13:15", content: "æŠµé”ä½›ç¾…å€«æ–¯ SMN è»Šç«™ã€‚" },
                                { time: "15:00", content: "å¸‚å€æ¼«æ­¥ï¼šç™¾èŠ±å¤§æ•™å ‚(å¤–è§€) â” é ˜ä¸»å»£å ´ â” è€æ©‹ã€‚" },
                                { time: "17:00", content: "æ­å…¬è»Šä¸Šç±³é–‹æœ—åŸºç¾…å»£å ´çœ‹å¤•é™½ã€‚" },
                                { time: "19:30", content: "æ™šé¤ï¼šæŒ‘æˆ°ä¸€å…¬æ–¤å¤§ç‰›æ’ (Bistecca)ã€‚" }
                            ]
                        },
                        {
                            title: "Day 5 | 2/16 (ä¸€) å¤§è¡›åƒèˆ‡åœ“é ‚",
                            icon: "fa-user-graduate",
                            stay: "",
                            activities: [
                                { time: "09:00", content: "å­¸é™¢ç¾è¡“é¤¨çœ‹å¤§è¡›åƒ (éœ€é ç´„)ã€‚" },
                                { time: "12:00", content: "ä¸­å¤®å¸‚å ´äºŒæ¨“ç¾é£Ÿè¡—åˆé¤ (ç‰›è‚šåŒ…)ã€‚" },
                                { time: "14:00", content: "è–æ¯ç™¾èŠ±å¤§æ•™å ‚ç™»é ‚ (å…„å¼Ÿ) / æ´—ç¦®å ‚ (çˆ¶æ¯)ã€‚" },
                                { time: "16:30", content: "åƒè§€éº¥åœ°å¥‡ç¦®æ‹œå ‚ã€‚" },
                                { time: "18:30", content: "è‡ªç”±æ´»å‹• / æ™šé¤ã€‚" }
                            ]
                        },
                        {
                            title: "Day 6 | 2/17 (äºŒ) æ‰˜æ–¯å¡å°¼çƒ¹é£ªé…’èŠ",
                            icon: "fa-wine-glass-alt",
                            stay: "",
                            activities: [
                                { time: "09:00", content: "é›†åˆå‡ºç™¼åƒåŠ  Cooking Class Tourã€‚" },
                                { time: "10:30", content: "æŠµé” Chianti è¾²èŠï¼Œé–‹å§‹çƒ¹é£ªèª²ç¨‹ã€‚" },
                                { time: "13:00", content: "äº«ç”¨è‡ªå·±åšçš„åˆé¤ã€‚" },
                                { time: "14:30", content: "åƒè§€è‘¡è„åœ’èˆ‡é…’çª–å“é…’ã€‚" },
                                { time: "17:00", content: "è¿”å›ä½›ç¾…å€«æ–¯å¸‚å€ã€‚" }
                            ]
                        },
                        {
                            title: "Day 7 | 2/18 (ä¸‰) çƒè²èŒ²èˆ‡æ²³å²¸",
                            icon: "fa-image",
                            stay: "",
                            activities: [
                                { time: "09:00", content: "åƒè§€çƒè²èŒ²ç¾è¡“é¤¨ (ç¶­ç´æ–¯çš„èª•ç”Ÿ)ã€‚" },
                                { time: "13:00", content: "åˆé¤å¾Œèµ°éè€æ©‹ã€‚" },
                                { time: "14:30", content: "Oltrarnoå€æ¼«æ­¥ (ç¢§æå®®èŠ±åœ’/å·¥åŒ åº—)ã€‚" },
                                { time: "17:00", content: "åƒè§€è–åå­—è–æ®¿ (ç±³é–‹æœ—åŸºç¾…ä¹‹å¢“)ã€‚" },
                                { time: "19:00", content: "æ™šé¤ã€‚" }
                            ]
                        }
                    ]
                },
                {
                    city: "BOLOGNA â€¢ æ³¢éš†é‚£",
                    subtitle: "èƒ–å­ä¹‹éƒ½èˆ‡é»‘æš—æ­·å² (Day 8-9)",
                    image: "https://images.unsplash.com/photo-1627833680456-294e671f1c27?q=80&w=2070&auto=format&fit=crop",
                    theme: "theme-bologna",
                    colorClass: "text-red-600",
                    borderClass: "border-red-500",
                    days: [
                        {
                            title: "Day 8 | 2/19 (å››) ç¾é£Ÿä¹‹éƒ½",
                            icon: "fa-utensils",
                            stay: "ä½å®¿ï¼šæ³¢éš†é‚£",
                            activities: [
                                { time: "09:30", content: "åƒè§€ä½›ç¾…å€«æ–¯ SMN ç™¾å¹´è—¥å¦åº—ã€‚" },
                                { time: "11:00", content: "æ­é«˜éµå‰å¾€æ³¢éš†é‚£ (è»Šç¨‹40åˆ†)ã€‚" },
                                { time: "13:00", content: "æŠµé”ä¸¦ Check-inã€‚" },
                                { time: "14:30", content: "é¦¬å–¬é›·å»£å ´æ¼«æ­¥ã€‚" },
                                { time: "15:30", content: "åƒè§€è§£å‰–åŠ‡å ´ (æœ¨é€ å¤è€è§£å‰–å®¤)ã€‚" },
                                { time: "18:00", content: "æ™šé¤ï¼šå¿…åƒ Tagliatelle al RagÃ¹ã€‚" }
                            ]
                        },
                        {
                            title: "Day 9 | 2/20 (äº”) æ‹±å»Šæœè–",
                            icon: "fa-archway",
                            stay: "",
                            activities: [
                                { time: "10:00", content: "Quadrilatero å¸‚å ´è©¦åƒç«è…¿èµ·å¸ã€‚" },
                                { time: "12:00", content: "å¸‚å ´åˆé¤ (Tortellini)ã€‚" },
                                { time: "14:00", content: "æ­ä¹˜å°ç«è»Šå‰å¾€è–è·¯åŠ è–æ¯æœè–åœ°ã€‚" },
                                { time: "17:00", content: "åƒè§€ä¸ƒæ•™å ‚å»ºç¯‰ç¾¤ã€‚" },
                                { time: "19:00", content: "æ™šé¤ã€‚" }
                            ]
                        }
                    ]
                },
                {
                    city: "MILANO â€¢ ç±³è˜­",
                    subtitle: "æ™‚å°šã€è—è¡“èˆ‡é›»å½±å°é® (Day 10-13)",
                    image: "https://images.unsplash.com/photo-1513581166391-887a96ddeafd?q=80&w=2070&auto=format&fit=crop",
                    theme: "theme-milan",
                    colorClass: "text-purple-600",
                    borderClass: "border-purple-500",
                    days: [
                        {
                            title: "Day 10 | 2/21 (å…­) æ™‚å°šä¹‹éƒ½",
                            icon: "fa-shopping-bag",
                            stay: "ä½å®¿ï¼šç±³è˜­",
                            activities: [
                                { time: "10:30", content: "æ­é«˜éµå‰å¾€ç±³è˜­ã€‚" },
                                { time: "12:00", content: "æŠµé”ç±³è˜­ï¼Œé£¯åº—å¯„æ”¾è¡Œæã€‚" },
                                { time: "14:30", content: "ç±³è˜­å¤§æ•™å ‚ç™»é ‚ (æ­é›»æ¢¯)ã€‚" },
                                { time: "16:30", content: "åƒè§€æ—é‚Šçš„äººéª¨å ‚ (San Bernardino)ã€‚" },
                                { time: "17:30", content: "é€›è‰¾æ›¼ç´äºŒä¸–è¿´å»Šã€‚" },
                                { time: "19:00", content: "é‹æ²³å€é«”é©— Aperitivo (Happy Hour)ã€‚" }
                            ]
                        },
                        {
                            title: "Day 11 | 2/22 (æ—¥) æœ€å¾Œçš„æ™šé¤",
                            icon: "fa-bible",
                            stay: "",
                            activities: [
                                { time: "09:45", content: "åƒè§€æœ€å¾Œçš„æ™šé¤ (é”æ–‡è¥¿çœŸè·¡)ã€‚" },
                                { time: "11:30", content: "å²ç¦æ‰åŸå ¡åƒè§€ã€‚" },
                                { time: "13:00", content: "Brera å€äº«ç”¨åˆé¤ã€‚" },
                                { time: "15:00", content: "æ£®çš®å¥§å…§å…¬åœ’æ•£æ­¥ã€‚" },
                                { time: "17:00", content: "ç±³è˜­å¸‚å€è‡ªç”±è³¼ç‰©ã€‚" }
                            ]
                        },
                        {
                            title: "Day 12 | 2/23 (ä¸€) Crema é›»å½±å°é®",
                            icon: "fa-film",
                            stay: "",
                            activities: [
                                { time: "09:30", content: "æ­å€é–“è»Šå‰å¾€ Crema (å…‹é›·é¦¬)ã€‚" },
                                { time: "11:00", content: "æŠµé” Cremaï¼Œé–‹å§‹å°é®æ¼«éŠã€‚" },
                                { time: "12:30", content: "åˆé¤ï¼šç‰¹è‰² Tortelli Cremaschiã€‚" },
                                { time: "14:00", content: "å°‹æ‰¾ã€Šä»¥ä½ çš„åå­—å‘¼å–šæˆ‘ã€‹é›»å½±å ´æ™¯ã€‚" },
                                { time: "16:30", content: "æ­ç«è»Šè¿”å›ç±³è˜­ã€‚" },
                                { time: "19:00", content: "æ…¶åŠŸæ™šé¤ï¼šç±³è˜­ç‡‰é£¯ã€‚" }
                            ]
                        },
                        {
                            title: "Day 13 | 2/24 (äºŒ) æ­¸é€”",
                            icon: "fa-plane-departure",
                            stay: "",
                            activities: [
                                { time: "07:00", content: "é£¯åº—é€€æˆ¿ã€‚" },
                                { time: "07:25", content: "æ­ä¹˜ Malpensa Express å‰å¾€æ©Ÿå ´ã€‚" },
                                { time: "08:20", content: "æŠµé”æ©Ÿå ´ï¼Œé ç•™æ™‚é–“è¾¦ç†é€€ç¨…ã€‚" },
                                { time: "11:00", content: "é£›æ©Ÿèµ·é£›ï¼ŒCiao Italy!" }
                            ]
                        }
                    ]
                }
            ]
        };

        // --- 2. State Management ---
        let appData = null;
        let isEditing = false;

        function initApp() {
            // Load from local storage or use default
            const savedData = localStorage.getItem('italyTripData_v2'); // Increment version for new schema
            if (savedData) {
                appData = JSON.parse(savedData);
                // Simple migration if 'luggage' is missing from saved data
                if(!appData.luggage) {
                    appData.luggage = defaultData.luggage;
                }
            } else {
                appData = JSON.parse(JSON.stringify(defaultData)); // Deep copy
            }
            
            renderAll();
        }

        function saveData() {
            localStorage.setItem('italyTripData_v2', JSON.stringify(appData));
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            document.body.classList.toggle('editing', isEditing);
            
            const btnText = document.getElementById('edit-btn-text');
            const btn = document.getElementById('edit-toggle-btn');
            
            if (isEditing) {
                btnText.innerText = "å®Œæˆç·¨è¼¯";
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-800');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                btnText.innerText = "ç·¨è¼¯å…§å®¹";
                btn.classList.add('bg-gray-700', 'hover:bg-gray-800');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
            
            renderAll();
        }

        // --- 3. View Switcher ---
        function switchTab(tabId) {
            // Update Tab UI
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            // Toggle Views
            if (tabId === 'itinerary') {
                document.getElementById('view-itinerary').classList.remove('hidden');
                document.getElementById('view-luggage').classList.add('hidden');
            } else {
                document.getElementById('view-itinerary').classList.add('hidden');
                document.getElementById('view-luggage').classList.remove('hidden');
            }
        }

        // --- 4. Rendering Logic ---

        function renderAll() {
            renderTransport();
            renderItinerary();
            renderLuggage();
        }

        function renderLuggage() {
            const container = document.getElementById('luggage-container');
            container.innerHTML = appData.luggage.map((cat, catIdx) => `
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm border border-gray-100 group/cat relative">
                    ${isEditing 
                        ? `<div class="flex justify-between items-center mb-4">
                             <input type="text" class="editable-input font-bold text-lg text-gray-700 flex-1" value="${cat.category}" onchange="updateLuggageCat(${catIdx}, this.value)">
                             <button onclick="removeLuggageCat(${catIdx})" class="text-red-400 hover:text-red-600 p-1"><i class="fas fa-trash"></i></button>
                           </div>`
                        : `<h3 class="font-bold text-lg mb-4 text-gray-700 border-b border-gray-200 pb-2">${cat.category}</h3>`
                    }
                    
                    <ul class="space-y-3">
                        ${cat.items.map((item, itemIdx) => `
                            <li class="flex items-center group/item">
                                ${isEditing 
                                    ? `<button onclick="removeLuggageItem(${catIdx}, ${itemIdx})" class="text-red-500 mr-2 hover:bg-red-100 rounded px-1"><i class="fas fa-times"></i></button>
                                       <input type="text" class="editable-input flex-1" value="${item}" onchange="updateLuggageItem(${catIdx}, ${itemIdx}, this.value)">` 
                                    : `<input type="checkbox" class="mr-3 h-5 w-5 text-green-600 rounded focus:ring-green-500"> 
                                       <span class="text-gray-700">${item}</span>`
                                }
                            </li>
                        `).join('')}
                        ${isEditing ? `<li class="mt-2"><button onclick="addLuggageItem(${catIdx})" class="text-blue-600 text-sm hover:underline">+ æ–°å¢é …ç›®</button></li>` : ''}
                    </ul>
                </div>
            `).join('');
        }

        // Helper to generate Google Maps Direction Link from Route String
        function getTransportMapLink(route) {
            const arrowRegex = /(?:â”|->|â†’|to|â†”)/i;
            if (arrowRegex.test(route)) {
                const parts = route.split(arrowRegex);
                if (parts.length >= 2) {
                    const origin = encodeURIComponent(parts[0].trim() + ", Italy"); // Append Italy
                    const dest = encodeURIComponent(parts[1].trim() + ", Italy"); // Append Italy
                    // å°èˆªé€£çµ: origin -> destination
                    return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
                }
            }
            // Fallback to simple search if no clear origin/dest
            return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(route + ", Italy")}`;
        }

        // Helper to generate Google Maps Search/Dir Link for Activity
        function getActivityMapLink(city, content) {
            // 1. Filter out generic activities that don't have a specific location
            const genericKeywords = ["è‡ªç”±æ´»å‹•", "åˆé¤", "æ™šé¤", "ä½å®¿", "é€€æˆ¿", "é›†åˆ", "è¿”å›", "æŠµé”", "è¾¦ç†", "ä¼‘æ¯"];
            if (genericKeywords.some(keyword => content.includes(keyword))) {
                return null; // Return null to indicate no link should be generated
            }

            // 2. Clean up the content to remove common verbs and punctuation for better search
            let queryTerm = content
                .replace(/^(åƒè§€|å‰å¾€|æ­ä¹˜|æ¢è¨ª|æŠµé”|è¾¦ç†|äº«å—|æŒ‘æˆ°|é›†åˆ|è¿”å›|å°‹æ‰¾|é€›|æ—©èµ·é€›|æ­èˆ¹å‰å¾€|æ­)/g, '') // Remove verbs
                .replace(/[ã€‚ï¼Œã€]/g, ' ') // Remove punctuation
                .trim();
            
            // 3. Extract potential POI name (take first part before parentheses if complex)
            // E.g. "è–é¦¬å¯å¤§æ•™å ‚ (å«é»ƒé‡‘ç¥­å£‡)" -> "è–é¦¬å¯å¤§æ•™å ‚"
            const simpleTerm = queryTerm.split('(')[0].trim();
            if(simpleTerm.length > 1) queryTerm = simpleTerm; // Use simpler term if valid

            // 4. Construct query with City and Country explicitly
            // "è–é¦¬å¯å¤§æ•™å ‚, Venice, Italy" - This forces Google Maps to look in Italy
            const query = encodeURIComponent(`${queryTerm}, ${city}, Italy`);
            
            // Use 'dir' with destination so user can navigate from where they are
            return `https://www.google.com/maps/dir/?api=1&destination=${query}`;
        }

        function renderTransport() {
            const tbody = document.getElementById('transport-body');
            tbody.innerHTML = appData.transport.map((row, index) => `
                <tr class="border-b hover:bg-gray-50 ${row.highlight ? 'bg-yellow-50' : ''}">
                    <td class="py-3 px-4">
                        ${isEditing 
                            ? `<input type="text" class="editable-input w-20" value="${row.date}" onchange="updateTransport(${index}, 'date', this.value)">` 
                            : `<span class="${row.highlight ? 'font-bold text-red-600' : ''}">${row.date}</span>`
                        }
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center">
                            ${isEditing 
                                ? `<input type="text" class="editable-input" value="${row.route}" onchange="updateTransport(${index}, 'route', this.value)">` 
                                : `<span class="${row.highlight ? 'font-semibold' : ''}">${row.route}</span>
                                   <a href="${getTransportMapLink(row.route)}" target="_blank" class="transport-map-btn no-print" title="æŸ¥çœ‹è·¯ç·š">
                                     <i class="fas fa-map-marked-alt mr-1"></i> è·¯ç·š
                                   </a>`
                            }
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        ${isEditing 
                            ? `<input type="text" class="editable-input" value="${row.time}" onchange="updateTransport(${index}, 'time', this.value)">` 
                            : `<span class="${row.highlight ? 'font-bold' : ''}">${row.time}</span>`
                        }
                    </td>
                    <td class="py-3 px-4 flex items-center">
                         ${isEditing 
                            ? `<input type="text" class="editable-input flex-1 mr-2" value="${row.type}" onchange="updateTransport(${index}, 'type', this.value)">
                               <button onclick="removeTransport(${index})" class="text-red-500 hover:bg-red-100 rounded px-1"><i class="fas fa-trash"></i></button>` 
                            : row.type
                        }
                    </td>
                </tr>
            `).join('') + (isEditing ? `<tr><td colspan="4" class="py-2 px-4"><button onclick="addTransport()" class="text-blue-600 text-sm hover:underline">+ æ–°å¢äº¤é€šè¡Œç¨‹</button></td></tr>` : '');
        }

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = appData.itinerary.map((block, blockIndex) => {
                // Extract English City Name for map context if available, otherwise use whole string
                // "VENEZIA â€¢ å¨å°¼æ–¯" -> "VENEZIA"
                const cityName = block.city.split('â€¢')[0]?.trim() || block.city;

                return `
                <div class="mb-12 group/block">
                    <!-- Block Header -->
                    <div class="flex items-center mb-4 relative">
                         ${isEditing ? `<button onclick="removeCityBlock(${blockIndex})" class="absolute -left-10 top-2 text-red-500 hover:bg-red-100 p-2 rounded-full"><i class="fas fa-trash-alt"></i></button>` : ''}
                        
                        <img src="${block.image}" alt="${block.city}" class="w-16 h-16 rounded-full object-cover mr-4 border-2 ${block.borderClass} shadow-md">
                        <div class="flex-1">
                            <h3 class="text-2xl font-bold ${block.colorClass}">
                                ${isEditing ? `<input type="text" class="editable-input" value="${block.city}" onchange="updateBlock(${blockIndex}, 'city', this.value)">` : block.city}
                            </h3>
                            <div class="text-sm text-gray-500">
                                ${isEditing ? `<input type="text" class="editable-input" value="${block.subtitle}" onchange="updateBlock(${blockIndex}, 'subtitle', this.value)">` : block.subtitle}
                            </div>
                        </div>
                    </div>

                    <!-- Days Loop -->
                    ${block.days.map((day, dayIndex) => `
                        <div class="${block.theme} p-6 rounded-r-lg mb-4 shadow-sm relative group/day">
                            
                            ${isEditing ? `
                                <div class="absolute right-2 top-2 flex gap-2">
                                    <button onclick="removeDay(${blockIndex}, ${dayIndex})" class="text-red-400 hover:text-red-600 hover:bg-white/50 p-1 rounded"><i class="fas fa-times"></i></button>
                                </div>
                            ` : ''}

                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-lg text-gray-800 flex items-center flex-1">
                                    <i class="fas ${day.icon} mr-2"></i> 
                                    ${isEditing ? `<input type="text" class="editable-input flex-1 font-bold" value="${day.title}" onchange="updateDay(${blockIndex}, ${dayIndex}, 'title', this.value)">` : day.title}
                                </h4>
                                ${day.stay ? `
                                    <span class="text-xs font-mono bg-white px-2 py-1 rounded border ml-2 whitespace-nowrap">
                                        ${isEditing ? `<input type="text" class="editable-input w-24" value="${day.stay}" onchange="updateDay(${blockIndex}, ${dayIndex}, 'stay', this.value)">` : day.stay}
                                    </span>
                                ` : ''}
                            </div>
                            
                            <div class="text-sm text-gray-700 space-y-2 pl-6 border-l-2 border-opacity-30 ${block.borderClass} ml-1">
                                ${day.activities.map((act, actIndex) => {
                                    const mapLink = getActivityMapLink(cityName, act.content);
                                    return `
                                    <div class="flex items-start group/act">
                                        <div class="time-col mr-2 pt-0.5">
                                            ${isEditing ? `<input type="text" class="editable-input w-16 text-xs" value="${act.time}" onchange="updateActivity(${blockIndex}, ${dayIndex}, ${actIndex}, 'time', this.value)">` : act.time}
                                        </div>
                                        <div class="flex-1 flex items-start">
                                             ${isEditing 
                                                ? `<div class="flex gap-2 w-full">
                                                    <input type="text" class="editable-input flex-1" value="${act.content}" onchange="updateActivity(${blockIndex}, ${dayIndex}, ${actIndex}, 'content', this.value)">
                                                    <button onclick="removeActivity(${blockIndex}, ${dayIndex}, ${actIndex})" class="text-red-400 hover:text-red-600"><i class="fas fa-minus-circle"></i></button>
                                                   </div>` 
                                                : `<div class="flex-1">${convertTags(act.content)}</div>
                                                   ${mapLink ? `<a href="${mapLink}" target="_blank" class="map-btn no-print" title="å°èˆªåˆ°æ­¤è™•">
                                                     <i class="fas fa-map-marker-alt"></i>
                                                   </a>` : ''}`
                                                }
                                        </div>
                                    </div>
                                `;}).join('')}
                                
                                ${isEditing ? `
                                    <button onclick="addActivity(${blockIndex}, ${dayIndex})" class="text-blue-600 text-xs hover:underline mt-2 block">+ æ–°å¢æ´»å‹•</button>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}

                    ${isEditing ? `
                        <button onclick="addDay(${blockIndex})" class="w-full py-2 border-2 border-dashed border-gray-300 text-gray-400 rounded hover:bg-gray-50 hover:text-gray-600 transition">+ æ–°å¢å¤©æ•¸ (${block.city})</button>
                    ` : ''}

                </div>
            `;}).join('');
        }

        // --- 4. Helpers ---
        function convertTags(text) {
            return text;
        }

        // --- 5. Action Handlers (Luggage) ---
        function updateLuggageCat(idx, val) {
            appData.luggage[idx].category = val;
            saveData();
        }
        function removeLuggageCat(idx) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ')) {
                appData.luggage.splice(idx, 1);
                saveData();
                renderLuggage();
            }
        }
        function addLuggageCategory() {
            appData.luggage.push({category: "æ–°åˆ†é¡", items: ["æ–°é …ç›®"]});
            saveData();
            renderLuggage();
        }
        function updateLuggageItem(catIdx, itemIdx, val) {
            appData.luggage[catIdx].items[itemIdx] = val;
            saveData();
        }
        function removeLuggageItem(catIdx, itemIdx) {
            appData.luggage[catIdx].items.splice(itemIdx, 1);
            saveData();
            renderLuggage();
        }
        function addLuggageItem(catIdx) {
            appData.luggage[catIdx].items.push("æ–°ç‰©å“");
            saveData();
            renderLuggage();
        }

        // --- 6. Action Handlers (Transport) ---
        function updateTransport(index, field, value) {
            appData.transport[index][field] = value;
            saveData();
        }
        function addTransport() {
            appData.transport.push({ date: "", route: "æ–°è¡Œç¨‹", time: "", type: "" });
            renderTransport();
            saveData();
        }
        function removeTransport(index) {
            appData.transport.splice(index, 1);
            renderTransport();
            saveData();
        }

        // --- 7. Action Handlers (Itinerary) ---
        function updateBlock(blockIdx, field, value) {
            appData.itinerary[blockIdx][field] = value;
            saveData();
        }
        function updateDay(blockIdx, dayIdx, field, value) {
            appData.itinerary[blockIdx].days[dayIdx][field] = value;
            saveData();
        }
        function updateActivity(blockIdx, dayIdx, actIdx, field, value) {
            appData.itinerary[blockIdx].days[dayIdx].activities[actIdx][field] = value;
            saveData();
        }
        
        function addActivity(blockIdx, dayIdx) {
            appData.itinerary[blockIdx].days[dayIdx].activities.push({ time: "00:00", content: "æ–°æ´»å‹•" });
            saveData();
            renderItinerary();
        }

        function removeActivity(blockIdx, dayIdx, actIdx) {
            appData.itinerary[blockIdx].days[dayIdx].activities.splice(actIdx, 1);
            saveData();
            renderItinerary();
        }

        // --- 8. Action Handlers (Day) ---
        function addDay(blockIdx) {
            appData.itinerary[blockIdx].days.push({
                title: "Day X | æ–°çš„ä¸€å¤©",
                icon: "fa-map-marker-alt",
                stay: "",
                activities: []
            });
            saveData();
            renderItinerary();
        }

        function removeDay(blockIdx, dayIdx) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©å—ï¼Ÿ")) {
                appData.itinerary[blockIdx].days.splice(dayIdx, 1);
                saveData();
                renderItinerary();
            }
        }

        // --- 9. Action Handlers (City Block) ---
        function addNewCityBlock() {
            appData.itinerary.push({
                city: "æ–°åŸå¸‚",
                subtitle: "åŸå¸‚æè¿°",
                image: "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=2070&auto=format&fit=crop", // generic travel img
                theme: "theme-florence", // default theme
                colorClass: "text-gray-700",
                borderClass: "border-gray-500",
                days: []
            });
            saveData();
            renderItinerary();
        }

        function removeCityBlock(index) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ•´å€‹åŸå¸‚å€å¡Šå—ï¼Ÿé€™å°‡åˆªé™¤è©²åŸå¸‚ä¸‹çš„æ‰€æœ‰è¡Œç¨‹ã€‚")) {
                appData.itinerary.splice(index, 1);
                saveData();
                renderItinerary();
            }
        }

        // --- Print Logic ---
        function handlePrint() {
            showToast('ğŸ–¨ï¸ åˆ—å°è¦–çª—å³å°‡é–‹å•Ÿ...');
            setTimeout(() => {
                window.print();
            }, 10);
        }

        function showToast(message) {
            let toast = document.createElement('div');
            toast.className = 'fixed top-8 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white px-6 py-4 rounded-xl shadow-2xl z-[9999] text-sm text-center transition-all duration-300 opacity-0 translate-y-[-20px] border border-gray-700 pointer-events-none';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            // Force reflow
            void toast.offsetWidth;
            toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // --- Chat Logic ---
        const chatWidget = document.getElementById('chat-widget');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const apiKey = ""; 

        function toggleChat() {
            chatWidget.classList.toggle('hidden');
            chatWidget.classList.toggle('scale-95');
            chatWidget.classList.toggle('opacity-0');
            
            if (!chatWidget.classList.contains('hidden')) {
                setTimeout(() => userInput.focus(), 100);
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            userInput.value = '';
            const loadingId = addLoading();

            try {
                // Prepare context from current edited itinerary
                const currentItineraryText = JSON.stringify(appData.itinerary);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are an expert Italian travel guide. The user is planning a trip. 
                                Here is their CURRENT ITINERARY JSON: ${currentItineraryText}.
                                
                                User question: ${message}
                                
                                Respond in Traditional Chinese (Taiwan). Be helpful and refer to their specific itinerary if relevant.`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.error) {
                    addMessage('æŠ±æ­‰ï¼ŒAI ç›®å‰å¿™ç¢Œä¸­ã€‚', 'bot');
                } else {
                    const botResponse = data.candidates[0].content.parts[0].text;
                    addMessage(botResponse, 'bot');
                }
            } catch (error) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                addMessage('é€£ç·šéŒ¯èª¤ã€‚', 'bot');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `chat-message flex gap-3 ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            const avatar = sender === 'user' 
                ? `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><i class="fas fa-user text-gray-500 text-xs"></i></div>`
                : `<div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-sparkles text-purple-600 text-xs"></i></div>`;
            const content = sender === 'user'
                ? `<div class="bg-purple-600 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[85%]">${text}</div>`
                : `<div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 max-w-[85%] border border-gray-100 markdown-body">${marked.parse(text)}</div>`;
            div.innerHTML = avatar + content;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'chat-message flex gap-3';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center flex-shrink-0"><i class="fas fa-sparkles text-purple-600 text-xs"></i></div>
                <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-500 border border-gray-100 flex gap-1 items-center h-10">
                    <div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                    <div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                    <div class="typing-dot w-1.5 h-1.5 bg-gray-400 rounded-full"></div>
                </div>
            `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        // Initialize App
        initApp();

    </script>
</body>
</html>
